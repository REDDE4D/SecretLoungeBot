import mongoose from "mongoose";
import dotenv from "dotenv";

dotenv.config();

const MONGO_URI = process.env.MONGO_URI;
const DBNAME = process.env.DBNAME;

if (!MONGO_URI || !DBNAME) {
  throw new Error("MONGO_URI and DBNAME environment variables are required");
}

/**
 * Connect to MongoDB
 * Reuses the same database as the main bot
 */
export async function connectDatabase() {
  try {
    await mongoose.connect(MONGO_URI, {
      dbName: DBNAME,
      serverSelectionTimeoutMS: 10000, // Timeout after 10s for initial connection
      socketTimeoutMS: 45000, // Close sockets after 45s of inactivity
      maxPoolSize: 10, // Max connection pool size
      minPoolSize: 2, // Min connection pool size
      connectTimeoutMS: 10000, // Connection timeout
      heartbeatFrequencyMS: 10000, // Check connection health every 10s
      retryWrites: true,
    });
    console.log(`✅ MongoDB connected: ${DBNAME}`);
  } catch (error) {
    console.error("❌ MongoDB connection error:", error.message);
    process.exit(1);
  }
}

/**
 * Graceful shutdown
 */
export async function disconnectDatabase() {
  try {
    await mongoose.connection.close();
    console.log("MongoDB connection closed");
  } catch (error) {
    console.error("Error closing MongoDB connection:", error.message);
  }
}

// Handle connection events
mongoose.connection.on("error", (err) => {
  console.error("MongoDB connection error:", err);
});

mongoose.connection.on("disconnected", () => {
  console.warn("MongoDB disconnected");
});

export default mongoose;
